# 用户画像分析平台 - 功能架构方案

## 项目概述

本项目旨在构建一个多维度、可交互的用户画像分析平台，支持按不同维度对用户进行分类分析，并提供灵活的数据筛选和可视化功能。

## 核心功能设计

### 1. 多维度用户分类体系

#### 1.1 发言量分类（优先实现）
- **主要发言人**: 发言量占比前15%
- **稳定发言人**: 发言量占比15%-60%
- **少量发言人**: 发言量占比60%-85%
- **极少发言人**: 发言量占比85%-100%

#### 1.2 发言类型分类
- 技术型、考试型、学习方法型、生活方式型
- 娱乐搞笑型、闲聊型、表情包型、社会技巧型

#### 1.3 时间习惯分类
- **早上型**: 6-10点发言占比>40%
- **熬夜型**: 0-6点发言占比>30%
- **作息规律**: 8-23点发言占比>80%
- **不规律型**: 在3个以上时间段都有20%发言

#### 1.4 社交行为分类
- **主动社交型**: 发起话题量占前30%
- **社交附和型**: 回复率>60%
- **被迫社交型**: 被@频率高(被@/总发言>0.2)

#### 1.5 其他分类维度
- 加群时间分类（老成员/新成员）
- 提问回答分类（提问型/回答型）
- 情感倾向分类（积极型/消极型）

### 2. UI界面架构

#### 2.1 顶部控制区域
```html
<div class="control-panel mb-4">
  <div class="row">
    <div class="col-md-3">
      <!-- 群聊筛选 -->
      <select id="groupSelector" class="form-select">
        <option value="">全部群聊</option>
      </select>
    </div>
    <div class="col-md-7">
      <!-- 分析维度选择 -->
      <ul class="nav nav-pills" id="dimensionTabs">
        <li class="nav-item">
          <a class="nav-link active" data-dimension="message_volume">
            <i class="fas fa-comments"></i> 发言量分析
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-dimension="time_pattern">
            <i class="fas fa-clock"></i> 时间习惯
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-dimension="content_type">
            <i class="fas fa-tags"></i> 发言类型
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-dimension="social_behavior">
            <i class="fas fa-users"></i> 社交行为
          </a>
        </li>
      </ul>
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-primary" onclick="exportCurrentView()">
        <i class="fas fa-download"></i> 导出
      </button>
    </div>
  </div>
</div>
```

#### 2.2 动态统计卡片区
```html
<div class="row mb-4" id="dynamicStats">
  <!-- 根据当前维度动态生成统计卡片 -->
</div>
```

#### 2.3 图表可视化区域
```html
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 id="chartTitle1"></h5>
      </div>
      <div class="card-body">
        <canvas id="primaryChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 id="chartTitle2"></h5>
      </div>
      <div class="card-body">
        <canvas id="secondaryChart"></canvas>
      </div>
    </div>
  </div>
</div>
```

### 3. 数据结构设计

#### 3.1 扩展用户画像数据结构
```javascript
const ExtendedUserProfile = {
  // 基础信息
  user_id: "string",
  nickname: "string",
  groups: ["群名1", "群名2"],
  platform: "qq|wechat",
  join_date: "2024-08-01",

  // 基础统计
  message_count: 123,
  avg_message_length: 25.5,

  // 多维度分析结果
  dimensions: {
    message_volume: {
      level: "主要发言人|稳定发言人|少量发言人|极少发言人",
      percentage: 85.5,        // 发言量百分位
      rank: 12,               // 排名
      score: 0.85,            // 标准化分数
      stats: {
        total_messages: 234,
        daily_average: 12.5,
        peak_day_messages: 45
      }
    },

    content_type: {
      primary_type: "技术型",
      confidence: 0.85,
      distribution: {
        "技术型": 0.45,
        "学习型": 0.30,
        "闲聊型": 0.15,
        "其他": 0.10
      },
      keywords: ["编程", "算法", "数据结构"]
    },

    time_pattern: {
      type: "熬夜型",
      peak_hours: [22, 23, 0, 1, 2],
      hourly_distribution: {
        "0-6": 0.25,
        "6-10": 0.05,
        "10-18": 0.30,
        "18-23": 0.40
      },
      activity_score: 0.75
    },

    social_behavior: {
      type: "主动型",
      metrics: {
        initiate_rate: 0.35,    // 话题发起率
        reply_rate: 0.45,       // 回复率
        mention_rate: 0.20,     // 提及他人率
        question_rate: 0.25,    // 提问率
        help_rate: 0.30         // 帮助他人率
      }
    },

    member_status: {
      type: "老成员|新成员",
      days_since_join: 45,
      growth_trend: "increasing|stable|decreasing"
    },

    interaction_style: {
      type: "提问型|回答型",
      question_ratio: 0.35,
      answer_ratio: 0.40,
      helpful_score: 0.75
    },

    sentiment: {
      overall_sentiment: "积极型|消极型",
      positive_ratio: 0.70,
      negative_ratio: 0.15,
      neutral_ratio: 0.15,
      emotion_distribution: {
        "开心": 0.40,
        "平静": 0.30,
        "焦虑": 0.20,
        "愤怒": 0.10
      }
    }
  },

  // 综合画像描述
  profile_summary: {
    tags: ["🔥话题主导者", "💻技术型", "🌙熬夜型", "🚀主动型"],
    description: "技术问题的引导者，深夜活跃，善于发起讨论",
    strength: ["技术能力强", "乐于助人", "活跃度高"],
    characteristics: ["深夜活跃", "技术导向", "主动交流"]
  }
};
```

#### 3.2 群组统计数据结构
```javascript
const GroupStatistics = {
  group_name: "群名",
  member_count: 123,
  active_member_count: 45,
  total_messages: 5678,

  // 按维度的群组统计
  dimension_stats: {
    message_volume: {
      "主要发言人": 8,
      "稳定发言人": 15,
      "少量发言人": 12,
      "极少发言人": 10
    },
    time_pattern: {
      "早上型": 5,
      "熬夜型": 12,
      "规律型": 20,
      "不规律型": 8
    }
    // ... 其他维度统计
  }
};
```

### 4. 核心功能实现

#### 4.1 维度控制器
```javascript
class DimensionController {
  constructor() {
    this.currentDimension = 'message_volume';
    this.currentGroup = '';
    this.filteredUsers = [];
    this.charts = {};

    this.initializeEventListeners();
  }

  // 初始化事件监听
  initializeEventListeners() {
    // 维度切换
    $('#dimensionTabs a').on('click', (e) => {
      e.preventDefault();
      const dimension = $(e.target).data('dimension');
      this.switchDimension(dimension);
    });

    // 群组筛选
    $('#groupSelector').on('change', (e) => {
      this.switchGroup(e.target.value);
    });
  }

  // 切换分析维度
  switchDimension(dimension) {
    this.currentDimension = dimension;

    // 更新UI状态
    this.updateTabsState(dimension);

    // 重新计算数据
    this.calculateDimensionData();

    // 更新所有组件
    this.updateStatCards();
    this.updateCharts();
    this.updateUserTable();

    console.log(`切换到维度: ${dimension}`);
  }

  // 切换群组筛选
  switchGroup(groupName) {
    this.currentGroup = groupName;

    // 过滤用户数据
    this.filterUsersByGroup();

    // 更新所有组件
    this.updateStatCards();
    this.updateCharts();
    this.updateUserTable();

    console.log(`筛选群组: ${groupName || '全部'}`);
  }

  // 按群组过滤用户
  filterUsersByGroup() {
    if (!this.currentGroup) {
      this.filteredUsers = analyticsData.users;
    } else {
      this.filteredUsers = analyticsData.users.filter(user =>
        user.all_groups && user.all_groups.includes(this.currentGroup)
      );
    }
  }

  // 计算当前维度的数据
  calculateDimensionData() {
    const users = this.getFilteredUsers();
    return this.calculateDimensionStats(users, this.currentDimension);
  }

  // 获取过滤后的用户
  getFilteredUsers() {
    return this.filteredUsers.length > 0 ? this.filteredUsers : analyticsData.users;
  }

  // 更新统计卡片
  updateStatCards() {
    const stats = this.calculateDimensionData();
    const statsHtml = this.generateStatsCards(stats);
    $('#dynamicStats').html(statsHtml);
  }

  // 更新图表
  updateCharts() {
    const config = this.getChartConfig();
    const data = this.getChartData();

    this.updatePrimaryChart(config.primary, data.primary);
    this.updateSecondaryChart(config.secondary, data.secondary);
  }

  // 更新用户表格
  updateUserTable() {
    const users = this.getFilteredUsers();
    const processedUsers = this.processUsersForCurrentDimension(users);
    this.refreshUserTable(processedUsers);
  }
}
```

#### 4.2 数据计算模块
```javascript
class DataCalculator {
  // 计算发言量分类
  static calculateMessageVolumeClassification(users) {
    // 排序用户按消息数量
    const sortedUsers = [...users].sort((a, b) => b.message_count - a.message_count);
    const totalUsers = sortedUsers.length;

    // 计算分类边界
    const boundaries = {
      major: Math.ceil(totalUsers * 0.15),        // 前15%
      stable: Math.ceil(totalUsers * 0.60),       // 前60%
      occasional: Math.ceil(totalUsers * 0.85)    // 前85%
    };

    // 分类结果
    const classification = {
      '主要发言人': [],
      '稳定发言人': [],
      '少量发言人': [],
      '极少发言人': []
    };

    sortedUsers.forEach((user, index) => {
      let category;
      if (index < boundaries.major) {
        category = '主要发言人';
      } else if (index < boundaries.stable) {
        category = '稳定发言人';
      } else if (index < boundaries.occasional) {
        category = '少量发言人';
      } else {
        category = '极少发言人';
      }

      // 扩展用户数据
      user.dimensions = user.dimensions || {};
      user.dimensions.message_volume = {
        level: category,
        rank: index + 1,
        percentage: ((totalUsers - index) / totalUsers * 100).toFixed(1),
        score: this.normalizeScore(user.message_count, sortedUsers)
      };

      classification[category].push(user);
    });

    return classification;
  }

  // 标准化分数计算
  static normalizeScore(value, allValues) {
    const values = allValues.map(item => item.message_count);
    const min = Math.min(...values);
    const max = Math.max(...values);
    return max === min ? 1 : (value - min) / (max - min);
  }

  // 计算时间模式分类
  static calculateTimePatternClassification(users) {
    // 需要原始消息时间数据，这里提供框架
    // 实际实现需要解析消息时间戳
    return {
      '早上型': [],
      '熬夜型': [],
      '规律型': [],
      '不规律型': []
    };
  }

  // 生成统计摘要
  static generateDimensionSummary(classification, dimension) {
    const summary = {
      total_users: 0,
      categories: {},
      top_users: [],
      insights: []
    };

    Object.keys(classification).forEach(category => {
      const users = classification[category];
      summary.total_users += users.length;
      summary.categories[category] = {
        count: users.length,
        percentage: 0, // 稍后计算
        avg_messages: users.reduce((sum, u) => sum + u.message_count, 0) / users.length || 0
      };
    });

    // 计算百分比
    Object.keys(summary.categories).forEach(category => {
      summary.categories[category].percentage =
        (summary.categories[category].count / summary.total_users * 100).toFixed(1);
    });

    // 获取top用户
    const allUsers = Object.values(classification).flat();
    summary.top_users = allUsers
      .sort((a, b) => b.message_count - a.message_count)
      .slice(0, 10);

    return summary;
  }
}
```

#### 4.3 图表配置映射
```javascript
const ChartConfigs = {
  message_volume: {
    primary: {
      type: 'doughnut',
      title: '发言量分类分布',
      dataKey: 'categories',
      colors: ['#007bff', '#28a745', '#ffc107', '#dc3545']
    },
    secondary: {
      type: 'bar',
      title: 'Top 20 活跃用户',
      dataKey: 'top_users',
      colors: ['#17a2b8']
    }
  },

  time_pattern: {
    primary: {
      type: 'doughnut',
      title: '作息类型分布',
      dataKey: 'categories',
      colors: ['#28a745', '#dc3545', '#007bff', '#ffc107']
    },
    secondary: {
      type: 'radar',
      title: '24小时活跃度分布',
      dataKey: 'hourly_activity',
      colors: ['#6610f2']
    }
  },

  content_type: {
    primary: {
      type: 'doughnut',
      title: '发言内容类型分布',
      dataKey: 'categories',
      colors: ['#007bff', '#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6610f2', '#fd7e14', '#20c997']
    },
    secondary: {
      type: 'wordcloud',
      title: '关键词云图',
      dataKey: 'keywords'
    }
  },

  social_behavior: {
    primary: {
      type: 'doughnut',
      title: '社交行为类型分布',
      dataKey: 'categories',
      colors: ['#28a745', '#ffc107', '#dc3545']
    },
    secondary: {
      type: 'scatter',
      title: '用户社交活跃度矩阵',
      dataKey: 'social_matrix',
      colors: ['#007bff']
    }
  }
};
```

### 5. 实现计划

#### 第一阶段：基础框架搭建（1-2天）
1. ✅ 添加控制面板UI组件
2. ✅ 实现基础的维度切换功能
3. ✅ 群组筛选功能实现
4. ✅ 数据结构扩展

#### 第二阶段：发言量维度完整实现（2-3天）
1. ✅ 发言量分类算法实现
2. ✅ 发言量维度图表配置
3. ✅ 用户表格动态更新
4. ✅ 统计卡片动态生成

#### 第三阶段：其他维度逐步实现（每个维度1-2天）
1. 🔄 时间习惯维度实现
2. 🔄 发言类型维度实现
3. 🔄 社交行为维度实现
4. 🔄 其他维度实现

#### 第四阶段：用户体验优化（1-2天）
1. 🔄 动画过渡效果
2. 🔄 响应式布局优化
3. 🔄 性能优化
4. 🔄 数据导出功能

### 6. 技术实现要点

#### 6.1 状态管理
- 使用单一控制器模式管理全局状态
- 维度切换和筛选状态独立管理
- 数据变更时统一更新所有相关组件

#### 6.2 性能优化
- 图表实例复用，避免重复创建
- 大数据集分页和虚拟化
- 延迟加载和按需计算
- 缓存计算结果

#### 6.3 数据处理
- 分离数据计算和UI更新逻辑
- 支持动态分类阈值调整
- 异常数据处理和边界情况
- 数据验证和完整性检查

#### 6.4 扩展性设计
- 维度配置化，便于新增维度
- 图表类型可配置
- 分类算法可插拔
- 支持自定义用户标签

### 7. API接口设计

#### 7.1 数据获取接口
```javascript
// 获取指定维度的用户分类数据
GET /api/users/classification?dimension=message_volume&group=xxx

// 获取用户详细画像
GET /api/users/{user_id}/profile?dimensions=all

// 获取群组统计信息
GET /api/groups/{group_name}/stats?dimension=xxx

// 导出当前视图数据
POST /api/export/current-view
```

#### 7.2 配置管理接口
```javascript
// 获取维度配置
GET /api/config/dimensions

// 更新分类阈值
PUT /api/config/thresholds

// 获取图表配置
GET /api/config/charts
```

### 8. 测试策略

#### 8.1 单元测试
- 数据分类算法测试
- 统计计算函数测试
- 边界值测试

#### 8.2 集成测试
- 维度切换功能测试
- 筛选功能测试
- 图表更新测试

#### 8.3 性能测试
- 大数据集处理性能
- 内存使用监控
- 响应时间测试

### 9. 部署和监控

#### 9.1 部署方案
- 静态资源CDN部署
- API服务容器化部署
- 数据库读写分离

#### 9.2 监控指标
- 页面加载时间
- 接口响应时间
- 用户操作行为
- 错误率监控

---

## 总结

本方案提供了一个完整的多维度用户画像分析平台架构，具有良好的扩展性和用户体验。通过分阶段实现，可以逐步完善系统功能，为用户提供深入的数据分析洞察。

关键特性：
- 🎯 多维度分析：支持7个主要分析维度
- 🔄 动态切换：实时切换分析视角
- 📊 丰富可视化：多种图表类型支持
- 🎛️ 灵活筛选：支持群组和条件筛选
- 📱 响应式设计：适配多种设备
- ⚡ 高性能：优化的数据处理和渲染

下一步可以根据实际需求和优先级，按计划逐步实现各个功能模块。